
<section id="person-profile" *ngIf="person">
    <div>
        <div class="row">
            <div class="col-12">
                <div class="card" style="padding:1%">
                    <div class="row">
                        <div class="col-2">
                            <div class="align-self-center halfway-fab text-center">
                                <a class="profile-image">                                    
                                    <img src="assets/img/portrait/avatars/avatar-08.png" 
                                    class="rounded-circle img-border gradient-summer width-100" 
                                    alt="Card image"
                                    *ngIf="!person.avatar_img || person.avatar_img.length <= 0"/>
                                
                                    <img alt="{{ person.name }}"
                                        class="rounded-circle img-border " 
                                        src="https://myvtmiim.blob.core.windows.net/avatars/{{ person.avatar_img }}" 											
                                        style="min-width:50px;width:100%;" 
                                        *ngIf="person.avatar_img && person.avatar_img.length > 0" />	
                                </a>
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="row">
                                <div class="col-12">
                                    <h3 style="font-weight:bold">
                                        {{ person.name }}
                                        <span *ngIf="person.financial_status == 3">												
                                            <i class="icon-wallet" style="color:orange"
                                            [title]="person.financial_description"
                                            ></i>
                                        </span>
                                        <span *ngIf="person.financial_status > 0 && person.financial_status != 3">
                                            <i class="icon-wallet" style="color:red"													
                                                [title]="person.financial_description"
                                            >
                                            </i>
                                        </span>
                                        <span *ngIf="person.scheduling_status == 3">												
                                            <i class="ft-calendar" style="color:orange"
                                                [title]="person.scheduling_description">
                                            </i>
                                        </span>
                                        <span *ngIf="person.scheduling_status > 0 && person.scheduling_status != 3">
                                            <i class="ft-calendar" style="color:red"													
                                                [title]="person.scheduling_description">
                                            </i>
                                        </span>
                                        <span *ngIf="person.comunication_status == 3">												
                                            <i class="far fa-envelope" style="color:orange"
                                            [title]="person.comunication_description"
                                            ></i>
                                        </span>
                                        <span *ngIf="person.comunication_status > 0 && person.comunication_status != 3">
                                            <i class="far fa-envelope" style="color:red"													
                                                [title]="person.comunication_description"
                                            >
                                            </i>
                                        </span>	
                                    </h3>
                                </div>                                
                            </div>
                            <div class="row" *ngIf="person.is_disciple && (person.kf_name_ideograms || person.kf_name_ideograms )">
                                <div class="col-5">
                                    <div>                                        
                                        <h4>
                                            {{ person.kf_name }} - {{ person.kf_name_ideograms }}
                                        </h4>                                                                                                                        
                                    </div>                                
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-2">
                                    <label for="admission_date">Nascimento</label> 
                                    <span id="admission_date" 
                                        [ngStyle]="{ 'color': !person.birth_date ? 'red' : null }">
                                        {{ person.birth_date_br || 'Não definido'  }}                                    
                                    </span>
                                </div>                                                                                                                                                                                 
                            </div>
                            <div class="row">
                                <div class="col-12" *ngIf="person.is_active_member || person.is_disciple || person.is_leaving || person.is_inactive_member">
                                    <h6 style="border-bottom: 1px solid black;margin-top:15px;font-weight:bold"> Membro </h6>
                                </div>
                            </div>
                            <div class="row" *ngIf="person.is_active_member || person.is_disciple || person.is_leaving || person.is_inactive_member">                                
                                <div class="col-2">
                                    <label for="branch">Núcleo</label> 
                                    <span id="branch"
                                        *ngIf="person.branch_name">
                                        {{ person.branch_name.replace("Núcleo", '') }}                                    
                                    </span>
                                    <span id="branch"
                                        *ngIf="!person.branch_name"
                                        style="color:red">
                                        Não definido
                                    </span>                            
                                </div>  
                                <div class="col-2">
                                    <label for="program">Programa</label> 
                                    <span id="program"
                                        *ngIf="person.program_name">
                                        {{ person.program_name.replace("Programa", '') }}                                    
                                    </span>
                                    <span id="branch"
                                        *ngIf="!person.program_name"
                                        style="color:red">
                                        Não definido
                                    </span>
                                </div>
                                <div class="col-3">
                                    <label for="domain" *ngIf="person.program_id == 3">
                                        Domínio
                                    </label> 
                                    <label for="domain" *ngIf="person.program_id != 3">
                                        Nível
                                    </label> 
                                    <span id="domain" 
                                        [ngStyle]="{ 'color': !person.domain_name ? 'red' : null }">
                                        {{ person.domain_name || 'Não definido'  }}                                    
                                    </span>
                                </div>   
                            </div>
                            <div class="row" 
                                style="padding-top:10px"
                                *ngIf="person.is_active_member || person.is_disciple || person.is_leaving || person.is_inactive_member">                                
                                <div class="col-2">
                                    <label for="family">Família</label> 
                                    <span id="family" *ngIf="person.family && person.family.length > 0 ">
                                        {{ person.family[0].name }}                                    
                                    </span>       
                                    <span id="family" style="color:red" *ngIf="!person.family || person.family.length <=0 ">
                                        Não definida
                                    </span>                                    
                                </div>  
                                <div class="col-2">
                                    <label for="admission_date">Admissão</label> 
                                    <span id="admission_date"
                                        [ngStyle]="{ 'color': !person.admission_date ? 'red' : null }">
                                        {{ person.admission_date_br || 'Não definida'  }}                                    
                                    </span>
                                </div>
                                <div class="col-2" *ngIf="person.is_disciple">
                                    <label for="baaisi_date">Baai Si</label> 
                                    <span id="baaisi_date" 
                                        [ngStyle]="{ 'color': !person.baaisi_date ? 'red' : null }">
                                        {{ person.baaisi_date_br || 'Não definido'  }}                                    
                                    </span>
                                </div>   
                            </div>
                            <div class="row" style="padding-top:15px">
                                <div class="col-12">
                                    <b>Papéis:</b>
                                    <ng-template ngFor let-person_role [ngForOf]="person.roles" let-pri=index let-m=first>                                
                                        <span *ngIf="pri > 0">,</span>
                                        <a (click)="begin_remove_role(person_role)"
                                        [ngStyle]="{'font-weight': person_role.removing ? 'bold' : null, 
                                                    'border-bottom': person_role.removing ? '1px dotted #000' : null }">
                                            {{ person_role.role }}
                                        </a>
                                        <button type="button" 
                                            (click)="remove_role(person_role.role_id)"
                                            class="btn btn-fab btn-danger btn-sm ft-trash-2"
                                            title="Confirmar Remoção de Papel"                                    
                                            style="margin-left:5px"
                                            *ngIf="person_role.removing"
                                            >										                                    			
                                        </button>
                                        <button type="button" 
                                            (click)="cancel_remove_role(person_role)"
                                            class="btn btn-fab btn-sm icon-action-undo"
                                            title="Cancelar Remoção"
                                            style="margin-left:5px"
                                            *ngIf="person_role.removing"
                                            >																
                                        </button>
                                    </ng-template>																
                                    
                                    <span *ngIf="!person.roles || person.roles.length == 0">Nenhum papel definido</span>
                                    <button
                                        (click)="open(new_role_modal)"
                                        class="btn btn-fab btn-sm btn-silver"
                                        title="Adicionar Papel"   
                                        style="margin-left:10px;padding:0 3px;margin:0;line-height:10px"                             
                                        >
                                        <i class="ft-plus"></i>                                        
                                        <i class="ft-user"></i>																
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-2 text-center">
                            <button type="button"                                 
                                [routerLink]="['/person/edit', id]"
                                class="btn btn-primary btn-lg"
                                title="Alterar pessoa"                                                                    
                                >			
                                <i class="icon-pencil"></i>		                                
                                Alterar											
                            </button>
                        </div>
                    </div>
                    <div class="row" style="padding-top:10px">
                        <div class="col-5 offset-2" *ngIf="person.last_activities && person.last_activities.length > 0">
                            <h5 style="border-bottom: 1px solid black"><i class="fa fa-tasks"></i> Atividades </h5>
                            <div class="row" *ngFor="let a of person.last_activities">
                                <div class="col-3">
                                
                                </div>
                            </div>
                        </div>
                        <div class="col-5">                            
                            <div class="row" style="border-bottom: 1px solid black">
                                <div class="col-10">
                                    <h5 style="padding:0;margin:0"><i class="ft-calendar"></i> Agendamento </h5>
                                </div>
                                <div class="col-2 text-right" style="padding-right:0">
                                    <button type="button" class="btn btn-silver btn-sm" 
                                        style="margin:0;padding:2px;line-height:10px"
                                        (click)="open(new_schedule_modal);">
                                        <i class="ft-plus"></i>                                        
                                        <i class="ft-calendar"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row" *ngIf="!person.scheduling || person.scheduling.length == 0">
                                <div class="col-12 text-center">
                                    Nenhum agendamento encontrado
                                </div>
                            </div>
                            <div class="row" *ngFor="let ps of person.scheduling">
                                <div class="col-3">
                                    {{ ps.type_description }}
                                </div>
                                <div class="col-7">
                                    {{ ps.recurrence_description }}
                                    <span *ngIf="ps.recurrence_type == 4">
                                        - Dia {{ ps.month_day }}
                                    </span>
                                    <span *ngIf="ps.recurrence_type == 2 || ps.recurrence_type == 3">
                                        - {{ ps.week_day_description + " " + ps.start_hour + ":" + ps.start_minute }}
                                    </span>
                                    <span *ngIf="ps.value > 0n">
                                        - {{ ps.value }}
                                    </span>
                                </div>
                                <div class="col-2 text-right" style="padding-right:0">
                                    <button type="button" class="btn btn-silver btn-sm" 
                                        style="margin:0;padding:2px;line-height:10px"			                                        
                                        *ngIf="!ps.begin_remove"
                                        (click)="begin_remove_schedule(ps);">
                                        <i class="ft-trash-2"></i>                                        
                                    </button>                                    
                                    <button type="button" class="btn btn-danger btn-sm" 
                                        *ngIf="ps.begin_remove"
                                        style="margin:0;padding:2px;line-height:10px"			                                        
                                        (click)="remove_schedule(ps);">
                                        <i class="ft-trash-2"></i>                                        
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" 
                                        *ngIf="ps.begin_remove"
                                        style="margin:0;padding:2px;line-height:10px"			                                        
                                        (click)="rollback_remove_schedule(ps);">
                                        <i class="icon-action-undo"></i>                                        
                                    </button>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>        
</section>


<ng-template #new_role_modal let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h5 class="modal-title" style="font-weight: bold">
            Adicionar Papel
        </h5>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">		
        <select id="branch" 
            [(ngModel)]="new_role" 
            class="form-control"                        
            >						
            <option *ngFor="let r of person.possible_roles" [value]="r.id">{{r.name}}</option>
        </select>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-success" 
            (click)="add_role();d('add role!');"
            *ngIf="new_role">
            <i class="icon-check"></i>
            Adicionar
        </button>        
        <button type="button" class="btn btn-silver" 			            
            (click)="d('Cancelled')">
            <i class="icon-action-undo"></i>
            Cancelar
        </button>        
    </div>
</ng-template>

<ng-template #new_schedule_modal let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h5 class="modal-title" style="font-weight: bold">Novo Agendamento</h5>
        <button type="button" class="close" aria-label="Close" (click)="reset_new_schedule();d('Cross click')">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body" *ngIf="new_schedule">			
        <div class="form-body">			
            <div class="row">
                <div class="col-12">
                    <fieldset class="form-group">						
                        <label for="new_schedule_branch"                             
                            style="font-weight: bold">
                            Núcleo
                        </label>		
                        <div class="form-group">
                            <select id="new_schedule_branch" 
                                [(ngModel)]="new_schedule.branch_id" 
                                (ngModelChange)="validate_new_schedule()"																	
                                class="form-control"								
                                >			
                                <option></option>			
                                <option *ngFor="let b of person.branches" [value]="b.id">{{b.name}}</option>
                            </select>								
                        </div>
                        <label for="new_schedule_tmp_type" style="font-weight: bold">Tipo de Atividade</label>																		
                        <span *ngIf="new_schedule.tmp_type != null">
                            {{ new_schedule.tmp_type.name }}
                            <span *ngIf="new_schedule.children_type != null">
                                - {{ new_schedule.children_type.name }}
                            </span>							

                            <i class="ft-rotate-ccw" 
                                (click)="reset_new_schedule_type();"
                                style="cursor: pointer;">
                            </i>							
                        </span>						
                        <select id="new_schedule_tmp_type"
                            class="form-control" 
                            [(ngModel)]="new_schedule.tmp_combo_type" 	
                            (ngModelChange)="change_new_schedule_type($event)"
                            *ngIf="new_schedule.tmp_type == null"
                            style="width:100%"
                            >		
                            <option></option>
                            <option *ngFor="let t of manual_incident_types" [value]="t.id">{{t.name}}</option>
                        </select>
                        <select id="new_schedule_children_type" 
                            [(ngModel)]="new_schedule.children_type" 
                            class="form-control" 
                            (ngModelChange)="change_new_schedule_children_type($event)"																								
                            *ngIf="new_schedule.tmp_type != null && new_schedule.children_type == null && new_schedule.tmp_type.childrens != null"
                            style="width:100%"
                            >						
                            <option *ngFor="let t of new_schedule.tmp_type.childrens" [value]="t.id">{{t.name}}</option>
                        </select>						
                    </fieldset>                                
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <label for="new_schedule_recurrence_types" style="font-weight: bold">Recorrência</label>
                </div>
                <div class="col-6">
                    <label for="new_schedule_number_of_incidents" style="font-weight: bold">Número de Eventos</label>
                </div>
            </div>            
            <div class="row">				
                <div class="col-6">
                    <div class="form-group">													
                        <select id="new_schedule_recurrence_types" 
                            [(ngModel)]="new_schedule.recurrence_type" 
                            (ngModelChange)="validate_new_schedule()"																	
                            class="form-control"								
                            >			
                            <option></option>			
                            <option *ngFor="let r of person.recurrence_types" [value]="r.id">{{r.description}}</option>
                        </select>	
                    </div>
                </div>
                <div class="col-6">					
                    <input type="number" id="new_schedule_number_of_incidents" 
                        [(ngModel)]="new_schedule.number_of_incidents"							
                        class="form-control text-right"
                        (ngModelChange) ="validate_new_schedule()" 						
                        />
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <label for="new_schedule_start_date" style="font-weight: bold">Data de Início</label>
                </div>
            </div>            
            <div class="row">				
                <div class="col-6">
                    <div class="form-group">													
                        <div class="input-group">							
                            <input class="form-control text-center" placeholder="dd/mm/aaaa" 
                            [(ngModel)]="new_schedule.start_date_tmp" id="new_schedule_start_date"
                            (ngModelChange) ="validate_new_schedule()"
                            ngbDatepicker #niReschedule="ngbDatepicker" />
                            <div class="input-group-addon" (click)="niReschedule.toggle()">
                                <i class="ft-calendar" style="cursor: pointer;"></i>
                            </div>																																
                        </div>	
                        
                    </div>
                </div>
                <div class="col-6">					
                    <ngb-timepicker [spinners]="false" 
                        [(ngModel)]="new_schedule.time"
                        (ngModelChange) ="validate_new_schedule()"></ngb-timepicker>					
                </div>
            </div>                         

            <div class="row" *ngIf="new_schedule.type != null">
                <div class="col-12">
                    <label for="new_schedule_description" style="font-weight: bold">Descrição</label>								
                    <textarea class="form-control"
                    id="new_schedule_description"
                    [(ngModel)]="new_schedule.description"							
                    (ngModelChange) ="validate_new_schedule()" 		
                    rows="3"></textarea>
                </div>
            </div>			
            <div class="row" *ngIf="new_schedule.type != null && new_schedule.type.need_value">
                <div class="col-12">
                    <label for="new_schedule_value" style="font-weight: bold">Valor</label>								
                    <input type="number" id="new_schedule_value" 
                        [(ngModel)]="new_schedule.value"							
                        class="form-control text-right"
                        (ngModelChange) ="validate_new_schedule_value()" 						
                        />                    
                </div>
            </div>
        </div>			
    </div>
    <div class="modal-footer">
        <button type="button" 
            class="btn btn-success" 
            (click)="save_schedule();d('new schedule!');"
            *ngIf="new_schedule.correct">
            <i class="icon-check"></i>
            Agendar
        </button>															
        <button type="button" class="btn btn-silver" 
            (click)="reset_new_schedule();d('reset new new_schedule!');"
            >
            <i class="icon-action-undo"></i>
            Cancelar
        </button>	
    </div>
</ng-template>